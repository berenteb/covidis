'use strict';
const Discord = require('discord.js');
const unirest = require('unirest');
const config = require('./config.json');
const indexes = require('./row_indexes.json');
const webhook = require("webhook-discord")
const Schedule = require('node-schedule');
const colors = require("colors");
const { getMapPromise, getDataPromise } = require("./hungary")
const sendNotification = require('./notification');
const { authorize, removeToken } = require('./auth')
// Create an instance of a Discord client
const client = new Discord.Client();

var timeout;
var retryCount = 0;

client.on('ready', (event) => {
    console.log('DiscordJS k√©szen √°ll!');
});

client.on('error', (event) => {
    console.log(event);
    process.exit(-1);
})

// Create an event listener for messages
client.on('message', message => {
    if (message.content.includes('!covid:')) {
        var messageSplit = message.content.split(":");
        if (messageSplit.length === 2) {
            message.react('‚ù§');
            var country = messageSplit[1];
            if (country !== null || country !== "") {
                country = formatCountryName(country);
                console.log(country + " keres√©se");
                sendMessage(country, message.channel);
                console.log("V√°lasz elk√ºldve".green);
            }
        }
    } else if (message.content === "!covidis") {
        message.react('‚ù§');
        message.channel.send("Hello!\nCOVidis bot vagyok\nOrsz√°gokr√≥l k√ºld√∂k koronav√≠rus inform√°ci√≥kat.\nHaszn√°lat:\n\t'!covid:<orsz√°g angol neve>'");
    } else if (message.content === "!sendwebhook") sendWebhook(message.channel);
    else if (message.content === "!rt") removeToken();
});

client.login(config.token);
authorize((auth) => {
    if (auth) {
        console.log("Google Auth sikeres.".green);
    } else {
        sendNotification('Hi! A Google Auth nem siker√ºlt!.', 'Beavatkoz√°s sz√ºks√©ges');
        console.log("Google Auth sikertelen.".red);
        process.exit(-1);
    }
})

//Countries other than World and US
function sendMessage(country, channel) {
    if (country === "Hungary") {
        getDataForHungary().then(data => {
            if (data.mapUrl) {
                var attachment = new Discord.MessageAttachment(data.mapUrl);
                channel.send(data.msg, attachment);
            } else {
                data.msg += "\n\nüó∫ A t√©rk√©pet nem tudtam megszerezni."
                channel.send(data.msg);
                
            }
            if (data.outdated) {
                channel.send("‚ùóÔ∏è Figyelem! Ez nem a mai adat! A legfrissebb adat√©rt n√©zz vissza k√©s≈ëbb!")
            }
        }).catch(err => {
            console.log(err.red);
            if (err === "Bejelentkez√©s sz√ºks√©ges") {
                sendMessage("Hungary", channel);
            } else if (err === "Sheets API hiba") {
                sendNotification("Hi! T√∂r√∂lni kellene a tokent √©s be kellene jelentkezni √∫jra!", "Beavatkoz√°s sz√ºks√©ges")
            } else {
                channel.send("‚ö°Ô∏è Nem siker√ºlt lek√©rnem az adatokat.");
            }
        })
    } else {
        getData(country).then(repsonse => {
            console.log("Siker, elk√ºldve!".green);
            channel.send(repsonse);
        }).catch(err => {
            console.log(err.red);
            channel.send(err);
        })
    }
}

function getDataForHungary() {
    return new Promise((resolve, reject) => {
        var result = { outdated: false };
        Promise.all([getDataPromise(), getMapPromise()]).then(data => {
            result.mapUrl = data[1];
            var statRaw = data[0];
            var stat = formatDataArray(statRaw);
            if (!stat) reject("‚ö°Ô∏è Nem siker√ºlt az adatokat lek√©rni!");
            var dataDateSplit = stat[0].split("-");
            var dataDate = {
                year: dataDateSplit[0],
                month: dataDateSplit[1],
                day: dataDateSplit[2]
            }
            var currentDate = new Date(Date.now());
            if (dataDate.year != currentDate.getFullYear() || dataDate.month != currentDate.getMonth()+1 || dataDate.day != currentDate.getDate()) {
                console.log(`Az adat d√°tuma: ${dataDate.year} ${dataDate.month} ${dataDate.day}`)
                result.outdated = true;
            }
            var msg = "üá≠üá∫ Magyarorsz√°g jelenlegi koronav√≠rus helyzete:\n\n"
            msg += `ü¶† √ñsszes eset: ${stat[indexes.cases]} (${stat[indexes.new_cases]})\n`;
            msg += `‚ñ∂Ô∏è Ebb≈ël akt√≠v: ${stat[indexes.active]}\n`;
            msg += `‚ò†Ô∏è Hal√°lesetek: ${stat[indexes.deaths]} (${stat[indexes.new_deaths]})\n`;
            msg += `üíö Meggy√≥gyult: ${stat[indexes.recovered]} (${stat[indexes.new_recovered]})\n`;
            msg += `üè• L√©legeztet≈ëg√©pen: ${stat[indexes.machine]} (${stat[indexes.new_machine]})\n`;
            msg += `üß™ Mintav√©telek sz√°ma: ${stat[indexes.tests]} (${stat[indexes.new_tests]})\n`;
            msg += `üíâ Beoltottak sz√°ma: ${stat[indexes.vaccine]} (${stat[indexes.new_vaccine]})\n`;
            msg += `üßÆ Pozit√≠v tesztek ar√°nya (√∂sszesen): ${stat[indexes.test_ratio]}\n`;
            result.msg = msg;
            resolve(result);
        }).catch(err => {
            reject(err);
        })
    })
}

function getData(country) {
    return new Promise((resolve, reject) => {
        var cases = 0;
        var deaths = 0;
        var recovered = 0;

        var req = unirest("GET", "https://covid-19-coronavirus-statistics.p.rapidapi.com/v1/total");

        req.query({
            "country": country
        });

        req.headers({
            "x-rapidapi-host": "covid-19-coronavirus-statistics.p.rapidapi.com",
            "x-rapidapi-key": config.rapid_api_key,
            "useQueryString": true
        });

        req.end(function (res) {
            if (res.error) reject("‚ö°Ô∏è Sajnos valamilyen hib√°ba √ºtk√∂ztem.")
            var body = JSON.parse(res.raw_body);
            if (body.message === "OK") {
                cases = body.data.confirmed;
                deaths = body.data.deaths;
                recovered = body.data.recovered;
                var messageText = `üåç ${country} jelenlegi koronav√≠rus helyzete:\n\nü¶† Esetek: ${numberWithCommas(cases)}\nüíÄ Hal√°lesetek: ${numberWithCommas(deaths)}\nüíö Meggy√≥gyult: ${numberWithCommas(recovered)}`;
                resolve(messageText);
            } else {
                reject("‚ö°Ô∏è Nem tal√°ltam inform√°ci√≥t ehhez az orsz√°ghoz.")
            }
        });
    })
}

var sendWebhook = function (channel) {
    console.log("WebHook k√ºld√©se");
    getDataForHungary().then(data => {
        const Hook = new webhook.Webhook(config.webhook);
        var d = new Date();
        const msg = new webhook.MessageBuilder()
            .setName("COVidis")
            .setColor("#7589DA")
            .setTitle(`Koronav√≠rus statisztik√°k ${d.getFullYear()}.${d.getMonth() + 1 < 10 ? "0" + (d.getMonth() + 1) : d.getMonth() + 1}.${d.getDate() < 10 ? "0" + (d.getDate()) : d.getDate()}.`)
            .setDescription(data.msg)
            .setImage(data.mapUrl);
        if (data.outdated === true) {
            console.log("R√©gi adat √©rkezett, √∫jrapr√≥b√°l√°s f√©l √≥ra m√∫lva.".red);
            if(channel)channel.send("R√©gi adat √©rkezett, √∫jrapr√≥b√°l√°s f√©l √≥ra m√∫lva.");
            // if(timeout) timeout.clearTimeout();
            if(retryCount < 5){
                timeout = setTimeout(sendWebhook, 10000);
                retryCount++;
            }else{
                console.log("Maximum √∫jrapr√≥b√°l√°s el√©rve!".red);
                retryCount = 0;
                sendNotification("Maximum √∫jrapr√≥b√°l√°s el√©rve a WebHook-n√°l","Beavatkoz√°s sz√ºks√©ges");
            }
        } else {
            retryCount = 0;
            timeout = undefined;
            console.log("WebHook sikeres!".green)
            Hook.send(msg);
        }
    }).catch(err => {
        console.log(err.red);
    })
}

function numberWithCommas(x) {
    var x_str = x.toString();
    var new_str = "";
    for (let i = 1; i <= x_str.length; i++) {
        new_str = x_str.charAt(x_str.length - i) + new_str;
        if (i % 3 === 0 && i != x_str.length && x_str.charAt(x_str.length - i - 1) != "-") {
            new_str = "," + new_str;
        }
    }
    return new_str;
}

function formatCountryName(str) {
    str = str.toLowerCase().trim();
    while (str.includes("  ")) {
        str = str.replace("  ", " ");
    }
    var str_split = str.split(" ");
    var new_str = "";
    str_split.forEach((part) => {
        part.trim();
        part = part.charAt(0).toUpperCase() + part.substring(1);
        if (new_str === "")
            new_str = part;
        else
            new_str += " " + part;
    });
    new_str.trim();
    return new_str;
}

function formatDataArray(dataArray) {
    if (Array.isArray(dataArray)) {
        for (let i = 0; i < dataArray.length; i++) {
            var data = dataArray[i];
            let isNum = /^(-{0,1}[0-9]+)$/.test(data);
            if (isNum) {
                // let isNegative = /^(-{1,1}[0-9]+)$/.test(data);
                var dataFormatted = /*`${isNegative?"":"+"}`+*/numberWithCommas(data);
                dataArray[i] = dataFormatted;
            }
        }
        return dataArray;
    } else
        return false;
}

var webhook_schedule = new Schedule.scheduleJob(config.rule, sendWebhook)